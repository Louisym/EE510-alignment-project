# EE510 æ¦‚ç‡è®ºæ™ºèƒ½é—®ç­”ç³»ç»Ÿ

åŸºäº RAG + GRPO çš„æ¦‚ç‡è®ºå­¦ä¹ è¾…åŠ©ç³»ç»Ÿ | [English](./README_EN.md)

## ğŸ“‹ é¡¹ç›®ç®€ä»‹

æœ¬é¡¹ç›®æ˜¯ä¸€ä¸ªé’ˆå¯¹æ¦‚ç‡è®ºã€æµ‹åº¦è®ºå’Œéšæœºè¿‡ç¨‹çš„æ™ºèƒ½é—®ç­”ç³»ç»Ÿï¼Œç»“åˆäº†æ£€ç´¢å¢å¼ºç”Ÿæˆï¼ˆRAGï¼‰å’Œåˆ†ç»„ç›¸å¯¹ç­–ç•¥ä¼˜åŒ–ï¼ˆGRPOï¼‰æŠ€æœ¯ï¼Œå®ç°äº†é«˜è´¨é‡çš„æ•°å­¦é—®ç­”èƒ½åŠ›ã€‚

### æ ¸å¿ƒç‰¹ç‚¹

- ğŸ¯ **æ¸è¿›å¼è®­ç»ƒç­–ç•¥**ï¼šBase Model â†’ SFT â†’ SVD-LoRA â†’ GRPOï¼Œç³»ç»Ÿæ€§æå‡æ¨¡å‹æ€§èƒ½
- ğŸ“Š **æ˜¾è‘—æ€§èƒ½æå‡**ï¼šç›¸æ¯”åŸºç¡€æ¨¡å‹å®ç° **55.5%** çš„æ€§èƒ½æå‡
- ğŸ” **RAG å¢å¼ºæ£€ç´¢**ï¼šåŸºäº ChromaDB çš„å‘é‡æ•°æ®åº“ï¼Œæä¾›å‡†ç¡®çš„çŸ¥è¯†æ£€ç´¢
- ğŸ’¡ **SVD åˆå§‹åŒ–ä¼˜åŒ–**ï¼šç›¸æ¯”éšæœºåˆå§‹åŒ–LoRAæå‡ **19.5%** çš„æµ‹è¯•æ€§èƒ½
- ğŸ¨ **å‹å¥½çš„ Web ç•Œé¢**ï¼šæ”¯æŒæ¨¡å‹å¯¹æ¯”ã€å®æ—¶é—®ç­”å’Œæ€§èƒ½å¯è§†åŒ–

### æ€§èƒ½æŒ‡æ ‡

| æ¨¡å‹ | å¹³å‡å¥–åŠ± | ç›¸å¯¹æå‡ |
|-----|---------|---------|
| åŸºç¡€æ¨¡å‹ | 0.231 | - |
| SFT Random-init | 0.253 | +9.5% |
| SFT SVD-init | 0.302 | +30.8% |
| **GRPO (æœ€ç»ˆ)** | **0.359** | **+55.5%** â­ |

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Gradio Web Interface                     â”‚
â”‚  (é—®ç­”ç•Œé¢ | æ¨¡å‹å¯¹æ¯” | æ€§èƒ½ç»Ÿè®¡ | ç³»ç»Ÿä¿¡æ¯)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                           â”‚
   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
   â”‚  GRPO    â”‚              â”‚   RAG    â”‚
   â”‚  Model   â”‚              â”‚  Engine  â”‚
   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
        â”‚                           â”‚
        â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
        â”‚                    â”‚  ChromaDB   â”‚
        â”‚                    â”‚ (BGE embed) â”‚
        â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Qwen2.5-Math-7B-Instruct (4-bit) â”‚
   â”‚     + LoRA (rank 16)              â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### è®­ç»ƒæµç¨‹

```
1. [SFT - ç›‘ç£å¾®è°ƒ]
   â”œâ”€â”€ Random-init LoRA â†’ è®­ç»ƒæŸå¤±: 0.7743
   â””â”€â”€ SVD-init LoRA    â†’ è®­ç»ƒæŸå¤±: 0.7718 (â†“0.32%)
                          æµ‹è¯•æ€§èƒ½: +19.5% vs Random

2. [GRPO - å¼ºåŒ–å­¦ä¹ å¯¹é½]
   â”œâ”€â”€ è®­ç»ƒ: 2 epochs, 162 steps, 3.5 hours
   â”œâ”€â”€ å¥–åŠ±æ¨¡å‹: 4ç»´å¯å‘å¼ (é•¿åº¦/å…¬å¼/æ¦‚å¿µ/ç»“æ„)
   â””â”€â”€ æœ€ç»ˆæ€§èƒ½: 0.359 reward (â†‘55.5% vs Base)

3. [RAG - æ£€ç´¢å¢å¼º]
   â”œâ”€â”€ å‘é‡åŒ–: 8ä¸ªæ¦‚ç‡è®ºæ–‡æ¡£ç« èŠ‚
   â”œâ”€â”€ æ£€ç´¢: Top-3ç›¸å…³ç‰‡æ®µ
   â””â”€â”€ ç”Ÿæˆ: åŸºäºæ£€ç´¢ä¸Šä¸‹æ–‡çš„å‡†ç¡®å›ç­”
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒè¦æ±‚

- **Python**: 3.8+
- **GPU**: CUDAå…¼å®¹GPUï¼Œè‡³å°‘ 8GB æ˜¾å­˜
- **å†…å­˜**: è‡³å°‘ 16GB RAM
- **å­˜å‚¨**: è‡³å°‘ 20GB å¯ç”¨ç©ºé—´

### å®‰è£…ä¾èµ–

```bash
# å…‹éš†ä»“åº“
git clone https://github.com/Louisym/EE510_alignment_project.git
cd EE510_alignment_project

# åˆ›å»ºè™šæ‹Ÿç¯å¢ƒï¼ˆæ¨èï¼‰
python -m venv .venv
source .venv/bin/activate  # Windows: .venv\Scripts\activate

# å®‰è£…ä¾èµ–
pip install -r requirements.txt
```

### å¯åŠ¨ Web åº”ç”¨

```bash
# æ–¹æ³•1ï¼šä½¿ç”¨å¯åŠ¨è„šæœ¬
./start_app.sh

# æ–¹æ³•2ï¼šç›´æ¥è¿è¡Œ
python app.py
```

è®¿é—® **http://127.0.0.1:7860** æ‰“å¼€ç•Œé¢ã€‚

**é¦–æ¬¡ä½¿ç”¨**ï¼šç‚¹å‡» "ğŸš€ Load System" æŒ‰é’®åŠ è½½æ¨¡å‹ï¼ˆéœ€è¦1-2åˆ†é’Ÿï¼‰ã€‚

## ğŸ“‚ é¡¹ç›®ç»“æ„

```
.
â”œâ”€â”€ app.py                      # Gradio Web åº”ç”¨ä¸»æ–‡ä»¶
â”œâ”€â”€ app_cn.py                   # ä¸­æ–‡ç‰ˆç•Œé¢ï¼ˆå¤‡ä»½ï¼‰
â”œâ”€â”€ app_en.py                   # è‹±æ–‡ç‰ˆç•Œé¢
â”œâ”€â”€ requirements.txt            # Python ä¾èµ–
â”œâ”€â”€ start_app.sh               # å¯åŠ¨è„šæœ¬
â”‚
â”œâ”€â”€ src/                       # æ ¸å¿ƒæºä»£ç 
â”‚   â”œâ”€â”€ vector_database.py    # ChromaDB å‘é‡æ•°æ®åº“
â”‚   â”œâ”€â”€ rag_pipeline.py        # RAG æ£€ç´¢ç®¡é“
â”‚   â”œâ”€â”€ document_processor.py  # æ–‡æ¡£å¤„ç†å™¨
â”‚   â”œâ”€â”€ model_loader.py        # æ¨¡å‹åŠ è½½å™¨
â”‚   â””â”€â”€ evaluation.py          # è¯„ä¼°å·¥å…·
â”‚
â”œâ”€â”€ training/                  # è®­ç»ƒæ¡†æ¶
â”‚   â”œâ”€â”€ sft/                  # ç›‘ç£å¾®è°ƒ (SFT)
â”‚   â”‚   â”œâ”€â”€ train_sft.py      # SFT è®­ç»ƒè„šæœ¬
â”‚   â”‚   â”œâ”€â”€ trainer.py        # SFT è®­ç»ƒå™¨
â”‚   â”‚   â”œâ”€â”€ data_loader.py    # æ•°æ®åŠ è½½å™¨
â”‚   â”‚   â””â”€â”€ config.py         # é…ç½®æ–‡ä»¶
â”‚   â”‚
â”‚   â””â”€â”€ grpo/                 # GRPO å¼ºåŒ–å­¦ä¹ 
â”‚       â”œâ”€â”€ train_grpo.py     # GRPO è®­ç»ƒè„šæœ¬
â”‚       â”œâ”€â”€ trainer.py        # GRPO è®­ç»ƒå™¨
â”‚       â”œâ”€â”€ reward_model.py   # å¥–åŠ±æ¨¡å‹
â”‚       â”œâ”€â”€ data_loader.py    # æ•°æ®åŠ è½½å™¨
â”‚       â””â”€â”€ config.py         # é…ç½®æ–‡ä»¶
â”‚
â”œâ”€â”€ experiments/              # å®éªŒä»£ç 
â”‚   â””â”€â”€ svd_lora/            # SVD-LoRA å¯¹æ¯”å®éªŒ
â”‚       â”œâ”€â”€ train_lora_svd_vs_rand.py  # å¯¹æ¯”è®­ç»ƒ
â”‚       â”œâ”€â”€ extract_svd_from_lora.py   # SVD æå–
â”‚       â””â”€â”€ training_results/          # ç»“æœ
â”‚
â”œâ”€â”€ data/                     # æ•°æ®ç›®å½•
â”‚   â”œâ”€â”€ chroma_db/           # å‘é‡æ•°æ®åº“
â”‚   â”œâ”€â”€ docs/                # åŸå§‹æ–‡æ¡£
â”‚   â””â”€â”€ training_data/       # è®­ç»ƒæ•°æ® (81 QAå¯¹)
â”‚
â””â”€â”€ outputs/                  # è®­ç»ƒè¾“å‡º
    â””â”€â”€ grpo/                # GRPO è®­ç»ƒç»“æœ
        â”œâ”€â”€ final_model/     # æœ€ç»ˆæ¨¡å‹
        â”œâ”€â”€ plots/           # è®­ç»ƒæ›²çº¿
        â””â”€â”€ metrics/         # æ€§èƒ½æŒ‡æ ‡
```

## ğŸ“ è®­ç»ƒæŒ‡å—

### 1. SFT è®­ç»ƒ

```bash
# ä½¿ç”¨éšæœºåˆå§‹åŒ– LoRA
python training/sft/train_sft.py \
  --config default \
  --train-data data/training_data/train.json \
  --output-dir outputs/sft/random \
  --epochs 3
```

### 2. SVD-LoRA å¯¹æ¯”å®éªŒ

```bash
python experiments/svd_lora/train_lora_svd_vs_rand.py \
  --base-model Qwen/Qwen2.5-Math-7B-Instruct \
  --train-data data/training_data/train.json \
  --lora-rank 16 \
  --epochs 3
```

### 3. GRPO è®­ç»ƒ

```bash
python training/grpo/train_grpo.py \
  --config from_sft \
  --sft-model outputs/sft/final_model \
  --train-data data/training_data/train.json \
  --output-dir outputs/grpo \
  --epochs 2
```

## ğŸ”§ æ ¸å¿ƒæŠ€æœ¯

### 1. RAG (Retrieval-Augmented Generation)

- **å‘é‡æ•°æ®åº“**: ChromaDB (æŒä¹…åŒ–å­˜å‚¨)
- **åµŒå…¥æ¨¡å‹**: BAAI/bge-base-en-v1.5
- **æ–‡æ¡£åˆ†å—**: 500å­—ç¬¦/å—ï¼Œ50å­—ç¬¦é‡å 
- **æ£€ç´¢ç­–ç•¥**: Top-3 ä½™å¼¦ç›¸ä¼¼åº¦

### 2. SVD-LoRA åˆå§‹åŒ–

**åŸç†**ï¼š
- è®­ç»ƒ teacher LoRA â†’ æå–æƒé‡çŸ©é˜µ Î”W
- SVDåˆ†è§£ï¼šÎ”W â‰ˆ BÂ·A
- ä½¿ç”¨ Bã€A åˆå§‹åŒ– student LoRA

**ä¼˜åŠ¿**ï¼šç›¸æ¯”éšæœºåˆå§‹åŒ–æå‡ **19.5%**

### 3. GRPO å¥–åŠ±æ¨¡å‹

4ç»´å¯å‘å¼è¯„åˆ†ï¼š

| ç»´åº¦ | æƒé‡ | è¯´æ˜ |
|-----|------|------|
| é•¿åº¦é€‚å½“æ€§ | 20% | å›ç­”é•¿åº¦ä¸å‚è€ƒç­”æ¡ˆæ¯”ä¾‹ |
| å…¬å¼å­˜åœ¨æ€§ | 30% | æ•°å­¦ç¬¦å·å’Œå…¬å¼ä½¿ç”¨ |
| æ¦‚å¿µè¦†ç›–åº¦ | 30% | å…³é”®æœ¯è¯­è¦†ç›– |
| ç»“æ„å®Œæ•´æ€§ | 20% | å®šä¹‰/å…¬å¼/ç¤ºä¾‹ç»“æ„ |

### 4. æ¨¡å‹é…ç½®

- **åŸºç¡€æ¨¡å‹**: Qwen/Qwen2.5-Math-7B-Instruct
- **é‡åŒ–**: 4-bit NF4 (BitsAndBytes)
- **LoRA Rank**: 16 (trainable params: ~1.2%)
- **æ˜¾å­˜å ç”¨**: ~5GB

## ğŸ“Š å®éªŒç»“æœ

### SVD-LoRA å¯¹æ¯”

| åˆå§‹åŒ–æ–¹æ³• | è®­ç»ƒæŸå¤± | æµ‹è¯•æ€§èƒ½ | æå‡ |
|-----------|---------|---------|------|
| Random    | 0.7743  | 0.253   | -    |
| SVD       | 0.7718  | 0.302   | **+19.5%** |

**å…³é”®å‘ç°**ï¼šè®­ç»ƒæŸå¤±ç›¸è¿‘ï¼ˆ0.32%ï¼‰ï¼Œä½†æµ‹è¯•æ€§èƒ½å·®å¼‚æ˜¾è‘—ï¼ˆ19.5%ï¼‰

### GRPO è®­ç»ƒ

| Epoch | Steps | Mean Reward | Max Reward |
|-------|-------|-------------|------------|
| 1     | 81    | 0.487       | 0.679      |
| 2     | 162   | 0.480       | 0.682      |
| Best  | 135   | **0.599**   | -          |

**Loss æ–¹å·®åˆ†æ**ï¼š
- Loss æ–¹å·®æ˜¯ Reward æ–¹å·®çš„ **592å€**
- è¿™æ˜¯æ­£å¸¸ç°è±¡ï¼ˆgroup-relative normalizationï¼‰
- åº”å…³æ³¨ reward æŒ‡æ ‡è€Œé loss

## âš ï¸ æ³¨æ„äº‹é¡¹

### æ¨¡å‹æƒé‡

å¤§å‹æ¨¡å‹æ–‡ä»¶ï¼ˆ*.safetensors, *.bin, *.pthï¼‰å› GitHubé™åˆ¶æœªåŒ…å«åœ¨ä»“åº“ä¸­ã€‚

**é¦–æ¬¡è¿è¡Œ**ï¼š
1. è‡ªåŠ¨ä» HuggingFace ä¸‹è½½åŸºç¡€æ¨¡å‹
2. æˆ–æŒ‰è®­ç»ƒæŒ‡å—è®­ç»ƒè‡ªå·±çš„æ¨¡å‹

### å¸¸è§é—®é¢˜

```bash
# åŠ è½½å¤±è´¥
ls outputs/grpo/final_model/  # æ£€æŸ¥æ¨¡å‹
nvidia-smi                     # æ£€æŸ¥GPU

# RAGæ— ç»“æœ
# é‡å»ºå‘é‡æ•°æ®åº“
python -c "from src.vector_database import VectorDatabase; db = VectorDatabase(); db.initialize()"
```

## ğŸ“š å‚è€ƒæ–‡çŒ®

1. **LoRA**: Hu et al., "LoRA: Low-Rank Adaptation of Large Language Models", ICLR 2022
2. **GRPO**: Shao et al., "DeepSeekMath: Pushing the Limits of Mathematical Reasoning", arXiv 2024
3. **RAG**: Lewis et al., "Retrieval-Augmented Generation for Knowledge-Intensive NLP Tasks", NeurIPS 2020

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®ä»…ç”¨äºå­¦æœ¯ç ”ç©¶å’Œæ•™è‚²ç›®çš„ã€‚

## ğŸ‘¥ ä½œè€…ä¿¡æ¯

- **è¯¾ç¨‹**: EE510 Probability Theory
- **å­¦æœŸ**: Spring 2025
- **æŠ€æœ¯æ ˆ**: PyTorch, Transformers, PEFT, Gradio, ChromaDB

---

<div align="center">

**ğŸ“ Generated with [Claude Code](https://claude.com/claude-code)**

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œæ¬¢è¿æäº¤ [Issue](https://github.com/Louisym/EE510_alignment_project/issues)

</div>
